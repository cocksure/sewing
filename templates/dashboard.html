{% extends 'base.html' %}
{% load static %}

{% block title %} {% endblock title %}

{% block dashboard %}
	<!-- Main Content -->
	<main class="admin-main">
		<div class="container-fluid p-2 p-lg-5">
			<!-- Page Header -->


			<!-- Stats Cards with Alpine.js -->
			<div class="row g-4 mb-4">
				<div class="col-xl-3 col-lg-6" x-data="statsCounter(12426, 5)">
					<div class="card stats-card">
						<div class="card-body">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									<div class="stats-icon bg-primary bg-opacity-10 text-primary">
										<i class="bi bi-people"></i>
									</div>
								</div>
								<div class="flex-grow-1 ms-3">
									<h6 class="mb-0 text-muted">Total Users</h6>
									<h3 class="mb-0" x-text="value.toLocaleString()" data-stat-value>5,426</h3>
									<small class="text-success">
										<i class="bi bi-arrow-up"></i> +12.5%
									</small>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-xl-3 col-lg-6">
					<div class="card stats-card">
						<div class="card-body">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									<div class="stats-icon bg-success bg-opacity-10 text-success">
										<i class="bi bi-graph-up"></i>
									</div>
								</div>
								<div class="flex-grow-1 ms-3">
									<h6 class="mb-0 text-muted">Revenue</h6>
									<h3 class="mb-0">$54,320</h3>
									<small class="text-success">
										<i class="bi bi-arrow-up"></i> +8.2%
									</small>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-xl-3 col-lg-6">
					<div class="card stats-card">
						<div class="card-body">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									<div class="stats-icon bg-warning bg-opacity-10 text-warning">
										<i class="bi bi-bag-check"></i>
									</div>
								</div>
								<div class="flex-grow-1 ms-3">
									<h6 class="mb-0 text-muted">Orders</h6>
									<h3 class="mb-0">1,852</h3>
									<small class="text-danger">
										<i class="bi bi-arrow-down"></i> -2.1%
									</small>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-xl-3 col-lg-6">
					<div class="card stats-card">
						<div class="card-body">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									<div class="stats-icon bg-info bg-opacity-10 text-info">
										<i class="bi bi-clock-history"></i>
									</div>
								</div>
								<div class="flex-grow-1 ms-3">
									<h6 class="mb-0 text-muted">Avg. Response</h6>
									<h3 class="mb-0">2.3s</h3>
									<small class="text-success">
										<i class="bi bi-arrow-up"></i> +5.4%
									</small>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Chart Section -->
			<div class="row g-4 mb-4">
				<div class="col-lg-8">
					<div class="card">
						<div class="card-header d-flex justify-content-between align-items-center">
							<h5 class="card-title mb-0">Revenue Overview</h5>
							<div class="btn-group btn-group-sm" role="group">
								<button type="button" class="btn btn-outline-primary active" data-chart-period="7d">7D
								</button>
								<button type="button" class="btn btn-outline-primary" data-chart-period="30d">30D
								</button>
								<button type="button" class="btn btn-outline-primary" data-chart-period="90d">90D
								</button>
								<button type="button" class="btn btn-outline-primary" data-chart-period="1y">1Y</button>
							</div>
						</div>
						<div class="card-body">
							<canvas id="revenueChart" height="250"></canvas>
						</div>
					</div>
				</div>

				<div class="col-lg-4">
					<div class="card">
						<div class="card-header">
							<h5 class="card-title mb-0">Recent Activity</h5>
						</div>
						<div class="card-body">
							<div class="activity-feed">
								<div class="activity-item">
									<div class="activity-icon bg-primary bg-opacity-10 text-primary">
										<i class="bi bi-person-plus"></i>
									</div>
									<div class="activity-content">
										<p class="mb-1">New user registered</p>
										<small class="text-muted">2 minutes ago</small>
									</div>
								</div>
								<div class="activity-item">
									<div class="activity-icon bg-success bg-opacity-10 text-success">
										<i class="bi bi-bag-check"></i>
									</div>
									<div class="activity-content">
										<p class="mb-1">Order #1234 completed</p>
										<small class="text-muted">5 minutes ago</small>
									</div>
								</div>
								<div class="activity-item">
									<div class="activity-icon bg-warning bg-opacity-10 text-warning">
										<i class="bi bi-exclamation-triangle"></i>
									</div>
									<div class="activity-content">
										<p class="mb-1">Server maintenance scheduled</p>
										<small class="text-muted">1 hour ago</small>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Additional Charts Row -->
			<div class="row g-4 mb-4">
				<div class="col-lg-6">
					<div class="card">
						<div class="card-header">
							<h5 class="card-title mb-0">User Growth (Last 7 Days)</h5>
						</div>
						<div class="card-body">
							<canvas id="userGrowthChart" height="200"></canvas>
						</div>
					</div>
				</div>

				<div class="col-lg-6">
					<div class="card">
						<div class="card-header">
							<h5 class="card-title mb-0">Order Status Distribution</h5>
						</div>
						<div class="card-body">
							<canvas id="orderStatusChart" height="200"></canvas>
						</div>
					</div>
				</div>
			</div>

		</div>
	</main>
{% endblock dashboard %}

{% block extra_js %}
<script>
// ===== Alpine компонент для анимированных счётчиков =====
document.addEventListener('alpine:init', () => {
  Alpine.data('statsCounter', (target = 0, durationSec = 1.5) => ({
    value: 0,
    init() {
      const start = performance.now();
      const duration = durationSec * 1000;
      const animate = (t) => {
        const p = Math.min((t - start) / duration, 1);
        this.value = Math.round(target * (0.1 + 0.9 * p)); // лёгкая ease-in
        if (p < 1) requestAnimationFrame(animate);
      };
      requestAnimationFrame(animate);
    }
  }));
});

// ===== Chart.js: безопасная инициализация, если канвасы есть =====
function newChart(ctx, cfg){ return new Chart(ctx, cfg); }

function initRevenueChart() {
  const el = document.getElementById('revenueChart');
  if (!el) return null;
  const labels = Array.from({length: 12}, (_, i) => `M${i+1}`);
  const data = [12, 19, 14, 22, 28, 25, 30, 27, 35, 40, 38, 44];
  return newChart(el, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Revenue',
        data,
        tension: 0.35,
        fill: false,
        pointRadius: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function initUserGrowthChart() {
  const el = document.getElementById('userGrowthChart');
  if (!el) return null;
  return newChart(el, {
    type: 'bar',
    data: {
      labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
      datasets: [{ label: 'Users', data: [35,42,51,48,60,72,68] }]
    },
    options: { plugins:{ legend:{ display:false } }, responsive:true, maintainAspectRatio:false }
  });
}

function initOrderStatusChart() {
  const el = document.getElementById('orderStatusChart');
  if (!el) return null;
  return newChart(el, {
    type: 'doughnut',
    data: {
      labels: ['Completed','Pending','Cancelled'],
      datasets: [{ data: [62, 26, 12] }]
    },
    options: { plugins:{ legend:{ position:'bottom' } }, responsive:true, maintainAspectRatio:false }
  });
}

let revenueChart;
window.addEventListener('load', () => {
  // графики
  revenueChart = initRevenueChart();
  initUserGrowthChart();
  initOrderStatusChart();

  // переключатели периода для revenueChart (если есть)
  document.querySelectorAll('[data-chart-period]').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!revenueChart) return;
      document.querySelectorAll('[data-chart-period].active').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      // простая подмена данных для демо
      const period = btn.dataset.chartPeriod;
      const set = {
        '7d':  [12,14,11,16,13,17,19],
        '30d': Array.from({length:30},()=>Math.floor(10+Math.random()*15)),
        '90d': Array.from({length:90},()=>Math.floor(8+Math.random()*18)),
        '1y':  Array.from({length:12},()=>Math.floor(15+Math.random()*30)),
      }[period] || revenueChart.data.datasets[0].data;

      revenueChart.data.labels = set.map((_,i)=>`${i+1}`);
      revenueChart.data.datasets[0].data = set;
      revenueChart.update();
    });
  });
});
</script>
{% endblock extra_js %}